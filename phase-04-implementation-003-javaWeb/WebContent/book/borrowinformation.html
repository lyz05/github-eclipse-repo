<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>借阅信息管理 - 图书借阅管理系统</title>
		<!-- bootstrap样式 -->
		<link rel="stylesheet" href="static/bootstrap/css/bootstrap.min.css">	
		<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
		<script src="static/js/jquery.min.js"></script>
		<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
		<script src="static/bootstrap/js/bootstrap.min.js"></script>
		<!-- 自定义js -->
		<script src="static/js/ajaxrequest.js"></script>
		<script src="static/js/jquery-form.js"></script>
		<!-- jQuery i18n -->
		<script src="static/js/jquery.json.min.js"></script>
		<script src="static/js/jquery.i18n.properties.js"></script>
		<script src="static/js/i18n.js"></script>
		<!-- Bootstrap日期插件 -->
		<link href="static/bootstrap/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
		<script src="static/js/moment-with-locales.js"></script>
		<script src="static/js/bootstrap-datetimepicker.min.js"></script>
	</head>

	<body>
		<div class="container-fluid">
			<!-- 顶栏 -->
			<div class="row">
				<div class="col-xs-6" style="margin:5px 0px">
					<span data-locale="hello">您好，</span><strong><span id="readername"></span></strong>
				</div>
				<div class="col-xs-6 text-right" style="margin:2px 0px">
				<div class="btn-group btn-group-sm">
					<a data-locale="alterpwd" role="button" class="btn btn-default" id="alterpwd" href="alterpassword.html">修改密码</a>
					<a data-locale="logout" role="button" class="btn btn-primary" href="javascript:logout()">注销</a>
				</div>
				</div>
			</div>
			
			<!-- 信息框栏 -->		
			<div class="row">
			<div class="col-xs-12">
			<div class="alert alert-info fade in" style="display: none;" role="alert" id="alert">
			   		alert message
			</div>
			</div>
			</div>
			
			<!-- 过滤器 -->
			<div class="row">
			<div class="col-xs-12">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title" id="panel-title">
						<span data-locale="bookinfo">图书信息</span>&nbsp;
						<span data-locale="filter">过滤器</span>
					</h3>
				</div>
				<div class="panel-body">
					<form class="form-horizontal" id="form1" onkeydown="if(event.keyCode==13)search(true);">
						<div class="form-group">
						<label class="col-sm-2 control-label" data-locale="bookno">图书编号</label>
						<div class="col-sm-3">
							<input class="form-control" name="bookno">
						</div>
						<label class="col-sm-2 col-sm-offset-2 control-label" data-locale="press">出版社</label>
						<div class="col-sm-3">
							<input class="form-control" name="press">
						</div>
						</div>
						<div class="form-group">
						<label class="col-sm-2 control-label" data-locale="bookname">图书名称</label>
						<div class="col-sm-3">
							<input class="form-control" name="bookname">
						</div>
						<label class="col-sm-2 col-sm-offset-2 control-label" data-locale="publishdate">出版日期</label>
						<div class="col-sm-3">
						<div class="row">
							<div class="col-xs-6">
								<div class="input-group date" id="datetimepicker1">
								<input data-locale-placeholder="begindate" class="form-control" placeholder="开始日期" name="publishdate_1" >
					            <span class="input-group-addon">
					            	<span class="glyphicon glyphicon-calendar"></span>
					            </span>
				                </div>
							</div>
							<div class="col-xs-6">
								<div class="input-group date" id="datetimepicker2">
								<input data-locale-placeholder="enddate" class="form-control" placeholder="结束日期" name="publishdate_2">
								<span class="input-group-addon">
									<span class="glyphicon glyphicon-calendar"></span>
								</span>
								</div>
							</div>
						</div>
						</div>
						</div>
						<div class="form-group">
						<label class="col-sm-2 control-label" data-locale="author">作者</label>
						<div class="col-sm-3">
							<input class="form-control" name="author">
						</div>
						<div class="col-sm-3 col-sm-offset-4 checkbox">
							<label class="control-label">
								<input name="check" type="checkbox"><span data-locale="onlybook">仅显示可借阅书籍</span>
							</label>
						</div>
						</div>
						<div class="form-group btn-group col-sm-12">
						<input data-locale-btn="search" type="button" value="查询"  class="btn btn-primary" onclick="search(true)">
						</div>
					</form>
				</div>
			</div>
			</div>
			</div>
			<!-- 导航栏 -->
			<div id="tabs">
			<ul class="nav nav-tabs" role="tablist" id="myTab">
			    <li role="presentation" class="active"><a data-locale="table-1" href="#tabs-1" aria-controls="tabs-1" role="tab" data-toggle="tab">当前借阅</a></li>
			    <li role="presentation"><a data-locale="table-2" href="#tabs-2" aria-controls="tabs-2" role="tab" data-toggle="tab">历史借阅</a></li>
				<li role="presentation"><a data-locale="bookinfo" href="#tabs-3" aria-controls="tabs-3" role="tab" data-toggle="tab">图书信息</a></li>
		  	</ul>
		  	<div class="tab-content">
		  		<!-- 当前借阅 -->
				<div role="tabpanel" class="tab-pane fade in active" id="tabs-1">
				<table class="table table-striped table-bordered table-hover" id="table-1">
					<tr><td>正在加载...</td></tr>
				</table>
				<div class="text-center">
					<label id="footer-table-1">正在加载...</label>
				</div>
				</div>
				<!-- 历史借阅 -->
				<div role="tabpanel" class="tab-pane fade" id="tabs-2">
					    <table class="table table-striped table-bordered table-hover" id="table-2">
					    	<tr><td>正在加载...</td></tr>
				</table>
				<div class="text-center">
					<label id="footer-table-2">正在加载...</label>
				</div>
				</div>
				<!-- 图书信息 -->
				<div role="tabpanel" class="tab-pane fade" id="tabs-3">
					    <table class="table table-striped table-bordered table-hover" id="table-3">
					    	<tr><td>正在加载...</td></tr>
				</table>
				<div class="text-center">
					<label id="footer-table-3">正在加载...</label>
				</div>
				</div>
			</div>
			</div>
		</div>
	</body>
	
	<script>
		$(document).ready(function(){
		    var picker1 = $('#datetimepicker1').datetimepicker({
		        format: 'YYYY-MM-DD',
		        locale: moment.locale(localStorage.getItem('LANGUAGE_CODE')),
		        //minDate: '2016-7-1'
		    });
		    var picker2 = $('#datetimepicker2').datetimepicker({
		        format: 'YYYY-MM-DD',
		        locale: moment.locale(localStorage.getItem('LANGUAGE_CODE'))
		    });
		    //动态设置最小值
		    picker1.on('dp.change', function (e) {
		        picker2.data('DateTimePicker').minDate(e.date);
		    });
		    //动态设置最大值
		    picker2.on('dp.change', function (e) {
		        picker1.data('DateTimePicker').maxDate(e.date);
		    });
            $('title').html($.i18n.prop('borrowinfo')+$.i18n.prop('management')+" - "+$.i18n.prop('systemname'));
		    search();
		});	
		//用于实现tabs切换
		$('#myTab a').click(function (e) {
		  e.preventDefault()
		  $(this).tab('show')
		})
		function search(flag){
			ajaxRequest("post","api/table",$('#form1').serialize()+"&table=View_Book",null,searchcallback3);
			ajaxRequest("post","api/table","table=Borrow",null,searchcallback1);
			ajaxRequest("post","api/table","table=BorrowHistory",null,searchcallback2);
			if (flag)
				$('#myTab a[href="#tabs-3"]').tab('show');
		}
		function searchcallback3(forminfo){
			displayforminfo("table-3",forminfo,function(tr,i){
				if (i == -1) {
					var th = window.document.createElement("th");
		            th.innerText = $.i18n.prop('operation');
		            tr.appendChild(th);
					return;
				}
				var td = window.document.createElement("td");
            	var a = window.document.createElement("a");
            	a.href = "javascript:borrow('"+forminfo.data[i][0]+"')";
            	a.innerText = $.i18n.prop('borrowbook');
          		td.appendChild(a);
          		tr.appendChild(td);
			});
		}
		function searchcallback1(forminfo){
			displayforminfo("table-1",forminfo,function (tr,i){
				if (i == -1) {
					var th = window.document.createElement("th");
		            th.innerText = $.i18n.prop('operation');
		            tr.appendChild(th);
					return;
				}
				var td = window.document.createElement("td");
            	var a = window.document.createElement("a");
            	a.href = "javascript:ret('"+forminfo.data[i][0]+"')";
            	a.innerText = $.i18n.prop('returnbook');
          		td.appendChild(a);
          		td.append(" | ");
            	var a = window.document.createElement("a");
            	a.href = "javascript:renew('"+forminfo.data[i][0]+"')";
            	a.innerText = $.i18n.prop('renewbook');
          		td.appendChild(a);
          		tr.appendChild(td);
			});
		}
		function searchcallback2(forminfo){
			displayforminfo("table-2",forminfo,function (tr,i){});
		}
		function borrow(bookno){
			ajaxRequest("get","api/borrowadd","bookno="+bookno, null, callBack);
		}
		function ret(bookno){
			ajaxRequest("get","api/borrowreturn","bookno="+bookno, null, callBack);
		}
		function renew(bookno){
			ajaxRequest("get","api/borrowrenew","bookno="+bookno, null, callBack);
		}
		function orderby(name, table){
			if (table=="table-1")
				ajaxRequest("post","api/table","table=Borrow&orderby="+name,null,searchcallback1);	
			if (table=="table-2")
				ajaxRequest("post","api/table","table=BorrowHistory&orderby="+name,null,searchcallback2);
			if (table=="table-3")
				ajaxRequest("post","api/table",$('#form1').serialize()+"&table=View_Book&orderby="+name,null,searchcallback3);
		}
		function displayforminfo(tablename,forminfo,operator){
			var alterpwd = window.document.getElementById("alterpwd");
			alterpwd.href = "alterpassword.html?username="+forminfo.username;
			var readername = window.document.getElementById("readername");
			readername.innerHTML = forminfo.readername;
			var footer = window.document.getElementById("footer-"+tablename);
			footer.innerHTML = $.i18n.prop('recordsfound')+forminfo.rows;
			var table = window.document.getElementById(tablename);
			table.innerHTML='';
			
            //创建标题行
            var thead = window.document.createElement("thead");
            var tr = window.document.createElement("tr");
            var itemHead = forminfo.name;
            for (var index in itemHead) {
                //创建标题单元格添加到thead
                var th = window.document.createElement("th");
                var a = window.document.createElement("a");
                a.innerText = itemHead[index];
                a.href="javascript:orderby('"+itemHead[index]+"','"+tablename+"')"
                th.appendChild(a);
                tr.appendChild(th);
            }
            operator(tr,-1);
            thead.appendChild(tr);
            table.appendChild(thead);
            
            var tbody = window.document.createElement("tbody");
            //遍历对象，创建行和单元格
            for (var i = 0; i < forminfo.rows; i++) {
                var item = forminfo.data[i];
                //创建行
                var tr = window.document.createElement("tr");
                for (var index in item) {
                    //创建单元格
                    var td = window.document.createElement("td");
                    td.innerText = item[index];
                    tr.appendChild(td);
                }
                operator(tr,i);
                tbody.appendChild(tr);
                //tr.appendChild(operatortd);
            }
            table.appendChild(tbody);
		}

  	</script>
</html>
