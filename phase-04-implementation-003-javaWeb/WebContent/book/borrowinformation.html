<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>借阅信息 - 图书借阅管理系统</title>
		<!-- bootstrap样式 -->
		<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
		<!-- 自定义样式 -->
		<link rel="stylesheet" href="css/style.css">
		
		<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
	    <script src="/static/jquery.min.js"></script>
	    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
	    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
	    <script src="/static/js/ajaxrequest.js"></script>
	</head>

	<body>
		<div class="header">
			<p>
				您好，<span id="readername"></span>
				<span class="right">
					<a id="alterpwd" href="alterpassword.html">修改密码</a>
					<a href="javascript:logout()">注销</a>
				</span>
			</p>
		</div>

		<!-- 过滤器 -->
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h3 class="panel-title">
					图书信息 过滤器
				</h3>
			</div>
			<div class="panel-body">
				<form id="form1" onkeydown="if(event.keyCode==13)search(true);">
					<p>
					<label>图书编号</label>
					<input name="bookno" value="">
					<span class="right">
					<label>出版社</label>
					<input name="press" value="">
					</span>
					</p>
					<p>
					<label>图书名称</label>
					<input name="bookname" value="">
					<span class="right">
					<label>出版日期</label>
					<input name="publishdate_1" value="">&nbsp;至&nbsp;<input name="publishdate_2"></span>
					</p>
					<p>
					<label>作者</label>
					<input name="author" value="">
					<span class="right">
					<label class="checkbox-inline">
					<input name="check" type="checkbox">
					仅显示可借阅书籍
					</label>
					</span>
					</p>
					<p>
					<input type="button" value="查询"  class="btn btn-primary" onclick="search(true)">
					</p>
				</form>
			</div>
		</div>

		<!-- 导航栏 -->
		<ul class="nav nav-tabs" role="tablist" id="myTab">
		    <li role="presentation" class="active"><a href="#tabs-1" aria-controls="tabs-1" role="tab" data-toggle="tab">当前借阅</a></li>
		    <li role="presentation"><a href="#tabs-2" aria-controls="tabs-2" role="tab" data-toggle="tab">历史借阅</a></li>
		    <li role="presentation"><a href="#tabs-3" aria-controls="tabs-3" role="tab" data-toggle="tab">图书信息</a></li>
	  	</ul>
	  	<div class="tab-content">
	  	<!-- 当前借阅 -->
		  <div role="tabpanel" class="tab-pane fade in active" id="tabs-1">
			<table class="table table-striped table-bordered table-hover" id="table-1">
				<tr><td>正在加载...</td></tr>
			</table>
		  </div>
		  <!-- 历史借阅 -->
		  <div role="tabpanel" class="tab-pane fade" id="tabs-2">
	   	    <table class="table table-striped table-bordered table-hover" id="table-2">
	   	    	<tr><td>正在加载...</td></tr>
			</table>
		  </div>
		  <!-- 图书信息 -->
		  <div role="tabpanel" class="tab-pane fade" id="tabs-3">
	   	    <table class="table table-striped table-bordered table-hover" id="table-3">
	   	    	<tr><td>正在加载...</td></tr>
			</table>
		  </div>
		</div>
	</body>
	
	<script>
		//用于实现tabs切换
		$('#myTab a').click(function (e) {
		  e.preventDefault()
		  $(this).tab('show')
		})
		function search(flag){
			ajaxRequest("post","api/table",$('#form1').serialize()+"&table=View_Book",null,searchcallback3);
			ajaxRequest("post","api/table","table=Borrow",null,searchcallback1);
			ajaxRequest("post","api/table","table=BorrowHistory",null,searchcallback2);
			if (flag)
				$('#myTab a[href="#tabs-3"]').tab('show');
		}
		function searchcallback3(forminfo){
			displayforminfo("table-3",forminfo,function(tr,i){
				if (i == -1) {
					var th = window.document.createElement("th");
		            th.innerText = "操作"
		            tr.appendChild(th);
					return;
				}
				var td = window.document.createElement("td");
            	var a = window.document.createElement("a");
            	a.href = "javascript:borrow('"+forminfo.data[i][0]+"')";
            	a.innerText = "借书";
          		td.appendChild(a);
          		tr.appendChild(td);
			});
		}
		function searchcallback1(forminfo){
			displayforminfo("table-1",forminfo,function (tr,i){
				if (i == -1) {
					var th = window.document.createElement("th");
		            th.innerText = "操作"
		            tr.appendChild(th);
					return;
				}
				var td = window.document.createElement("td");
            	var a = window.document.createElement("a");
            	a.href = "javascript:ret('"+forminfo.data[i][0]+"')";
            	a.innerText = "还书";
          		td.appendChild(a);
          		td.append(" | ");
            	var a = window.document.createElement("a");
            	a.href = "javascript:renew('"+forminfo.data[i][0]+"')";
            	a.innerText = "续借";
          		td.appendChild(a);
          		tr.appendChild(td);
			});
		}
		function searchcallback2(forminfo){
			displayforminfo("table-2",forminfo,function (tr,i){});
		}
		function borrow(bookno){
			ajaxRequest("get","api/borrowadd","bookno="+bookno, null, callBack);
		}
		function ret(bookno){
			ajaxRequest("get","api/borrowreturn","bookno="+bookno, null, callBack);
		}
		function renew(bookno){
			ajaxRequest("get","api/borrowrenew","bookno="+bookno, null, callBack);
		}
		function orderby(name, table){
			if (table=="table-1")
				ajaxRequest("post","api/table","table=Borrow&orderby="+name,null,searchcallback1);	
			if (table=="table-2")
				ajaxRequest("post","api/table","table=BorrowHistory&orderby="+name,null,searchcallback2);
			if (table=="table-3")
				ajaxRequest("post","api/table",$('#form1').serialize()+"&table=View_Book&orderby="+name,null,searchcallback3);
		}
		function displayforminfo(tablename,forminfo,operator){
			var alterpwd = window.document.getElementById("alterpwd");
			alterpwd.href = "alterpassword.html?username="+forminfo.username;
			var readername = window.document.getElementById("readername");
			readername.innerHTML = forminfo.readername;
			var table = window.document.getElementById(tablename);
			table.innerHTML='';
			
            //创建标题行
            var thead = window.document.createElement("thead");
            var tr = window.document.createElement("tr");
            var itemHead = forminfo.name;
            for (var index in itemHead) {
                //创建标题单元格添加到thead
                var th = window.document.createElement("th");
                var a = window.document.createElement("a");
                a.innerText = itemHead[index];
                a.href="javascript:orderby('"+itemHead[index]+"','"+tablename+"')"
                th.appendChild(a);
                tr.appendChild(th);
            }
            operator(tr,-1);
            thead.appendChild(tr);
            table.appendChild(thead);
            
            var tbody = window.document.createElement("tbody");
            //遍历对象，创建行和单元格
            for (var i = 0; i < forminfo.rows; i++) {
                var item = forminfo.data[i];
                //创建行
                var tr = window.document.createElement("tr");
                for (var index in item) {
                    //创建单元格
                    var td = window.document.createElement("td");
                    td.innerText = item[index];
                    tr.appendChild(td);
                }
                operator(tr,i);
                tbody.appendChild(tr);
                //tr.appendChild(operatortd);
            }
            table.appendChild(tbody);
		}
		//回调函数
		function callBack(result){
			if (result.code == 200) {
				search();
			}
		}
		window.onload = search();
  	</script>
</html>
